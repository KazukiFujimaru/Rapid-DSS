{% extends "base.html" %}
{% block body %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container-fluid pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
        <div>
            <h3 class="fw-bold mb-0">üèÜ Dashboard Keputusan</h3>
            <p class="text-muted small mb-0">Algoritma Terpilih: <span class="badge bg-primary">{{ algo_title }}</span></p>
        </div>
        <a href="{{ url_for('index') }}" class="btn btn-outline-danger btn-sm">Mulai Proyek Baru</a>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="card shadow-sm mb-4 border-0">
                <div class="card-header bg-white fw-bold border-0 pt-3">üìä Bobot Kriteria (Prioritas)</div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        {% for k, v in weights.items() %}
                        <div class="border rounded px-3 py-2 flex-fill text-center bg-light">
                            <small class="text-muted d-block">{{ k }}</small>
                            <span class="fw-bold text-primary">{{ "%.1f"|format(v*100) }}%</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-header bg-white fw-bold border-0 pt-3">üï∏Ô∏è Profil Kandidat Juara (Top 3)</div>
                <div class="card-body">
                    <div style="height: 300px; position: relative;">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card shadow border-success border-2 mb-4">
                <div class="card-header bg-success text-white fw-bold d-flex justify-content-between">
                    <span>ü•á Top 3 Rekomendasi</span>
                    <small>Skor Tertinggi Menang</small>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        {{ top3_html|safe }}
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-header bg-white fw-bold border-0 pt-3">üî• Peta Kekuatan Top 3 (Heatmap)</div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm text-center mb-0" style="font-size: 0.9rem;">
                            <thead>
                                <tr>
                                    <th>Alternatif</th>
                                    {% for col in heatmap_top3.columns %}<th>{{col}}</th>{% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for idx, row in heatmap_top3.iterrows() %}
                                <tr>
                                    <td class="fw-bold">{{ idx }}</td>
                                    {% for col in heatmap_top3.columns %}
                                        {% set val = row[col] %}
                                        {% set hue = val * 120 %}
                                        <td style="background-color: hsl({{ hue }}, 80%, 75%); color: #000;">
                                            {{ "%.2f"|format(val) }}
                                        </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer bg-white border-0 text-muted small text-center">
                        *Hijau = Unggul (Nilai Ternormalisasi Tinggi), Merah = Lemah
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card bg-light border-0 mt-5 p-4 rounded-3 text-center">
        <h5 class="fw-bold mb-3">Ingin Menelusuri Lebih Dalam?</h5>
        <div class="d-flex justify-content-center gap-3">
            <button class="btn btn-secondary px-4 py-2 shadow-sm" data-bs-toggle="modal" data-bs-target="#stepsModal">
                üìú Lihat Rincian Perhitungan Lengkap
            </button>
            <a href="{{ url_for('analysis') }}" class="btn btn-primary px-4 py-2 shadow-sm">
                üîç Masuk ke Mode Analisis Mendalam &rarr;
            </a>
        </div>
    </div>
</div>

<div class="modal fade" id="stepsModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Rincian Kalkulasi Algoritma (Step-by-Step)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                
                <div class="card mb-4 shadow-sm border-0">
                    <div class="card-header fw-bold bg-warning text-dark border-bottom">üî• Visualisasi Heatmap (Semua Data)</div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm text-center mb-0 table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Alternatif</th>
                                        {% for col in heatmap_full.columns %}<th>{{col}}</th>{% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for idx, row in heatmap_full.iterrows() %}
                                    <tr>
                                        <td class="fw-bold">{{ idx }}</td>
                                        {% for col in heatmap_full.columns %}
                                            {% set val = row[col] %}
                                            {% set hue = val * 120 %}
                                            <td style="background-color: hsl({{ hue }}, 80%, 75%); color: #000; font-weight: 500;">
                                                {{ "%.3f"|format(val) }}
                                            </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                {% for step_name, step_html in steps.items() %}
                    <div class="card mb-4 shadow-sm border-0">
                        <div class="card-header fw-bold border-bottom">{{ step_name }}</div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                {{ step_html|safe }}
                            </div>
                        </div>
                    </div>
                {% endfor %}
                
                <div class="card mb-4 shadow-sm border-success border-2">
                    <div class="card-header fw-bold bg-success text-white">Hasil Ranking Lengkap</div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            {{ result_html|safe }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const ctx = document.getElementById('radarChart').getContext('2d');
    const initData = JSON.parse('{{ chart_data | safe }}');
    
    new Chart(ctx, {
        type: 'radar',
        data: initData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { r: { suggestedMin: 0, suggestedMax: 1, ticks: { display: false } } },
            plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } }
        }
    });
</script>
{% endblock %}