{% extends "base.html" %}
{% block body %}

<div class="row justify-content-center mb-4">
    <div class="col-md-8 text-center">
        <h3 class="fw-bold text-dark">Sensitivity Analysis</h3>
        <p class="text-muted small">Uji ketahanan keputusan dengan mengubah bobot. Total bobot otomatis dijaga tetap 100%.</p>
    </div>
</div>

<div class="row g-4 mb-5">
    <div class="col-md-5">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                <span><i class="fas fa-sliders-h me-2 text-primary"></i><strong>Uji Perubahan Bobot</strong></span>
                <button class="btn btn-outline-danger btn-sm py-0" onclick="location.reload()" title="Reset ke Default">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
            <div class="card-body bg-light">
                <p class="small text-muted mb-4">Geser slider untuk mengubah prioritas. Grafik di kanan akan update otomatis.</p>
                
                <form id="sensitivityForm">
                    {% for criteria, weight in weights.items() %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <label class="small fw-bold text-dark">{{ criteria }}</label>
                            <span class="badge bg-primary rounded-pill" id="badge_{{ criteria }}">{{ "%.1f"|format(weight * 100) }}%</span>
                        </div>
                        <input type="range" class="form-range weight-slider" 
                               name="{{ criteria }}" 
                               id="slider_{{ criteria }}"
                               min="0" max="100" step="0.1" 
                               value="{{ (weight * 100)|round(1) }}">
                    </div>
                    {% endfor %}
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-7">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white py-3 border-bottom">
                <i class="fas fa-chart-bar me-2 text-primary"></i><strong>Simulasi Ranking Baru</strong>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs nav-fill mb-3" id="simTab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active small" id="chart-tab" data-bs-toggle="tab" data-bs-target="#sim-chart" type="button">Visualisasi Grafik</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link small" id="table-tab" data-bs-toggle="tab" data-bs-target="#sim-table" type="button">Tabel Ranking</button>
                    </li>
                </ul>

                <div class="tab-content" id="simTabContent">
                    <div class="tab-pane fade show active" id="sim-chart">
                        <div style="height: 300px;">
                            <canvas id="liveChart"></canvas>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="sim-table">
                        <div id="liveTableContainer" class="table-responsive small">
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-spinner fa-spin me-2"></i> Menunggu data...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<hr class="my-5 opacity-25">

<div class="row mb-5">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-3 border-bottom">
                <i class="fas fa-balance-scale me-2 text-warning"></i><strong>Head-to-Head Comparison</strong>
            </div>
            <div class="card-body p-4">
                
                <div class="row justify-content-center align-items-center mb-4 g-3">
                    <div class="col-md-4">
                        <select class="form-select form-select-lg shadow-sm border-primary" id="selectA"></select>
                    </div>
                    <div class="col-md-1 text-center">
                        <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center border" style="width: 40px; height: 40px;">
                            <span class="fw-bold text-muted">VS</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select form-select-lg shadow-sm border-danger" id="selectB"></select>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-lg-7">
                        <div class="table-responsive rounded border">
                            <table class="table table-striped align-middle mb-0 text-center">
                                <thead class="table-light">
                                    <tr>
                                        <th class="text-start ps-4">Kriteria</th>
                                        <th class="text-primary" id="thA">Kandidat A</th>
                                        <th class="text-danger" id="thB">Kandidat B</th>
                                        <th>Selisih</th>
                                    </tr>
                                </thead>
                                <tbody id="compareBody"></tbody>
                                <tfoot id="compareFooter" class="fw-bold"></tfoot>
                            </table>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="border rounded p-2 bg-light h-100">
                            <canvas id="compareRadar"></canvas>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="row mb-5">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                <span><i class="fas fa-check-double me-2 text-success"></i><strong>Validasi Metode (Robustness Check)</strong></span>
                <span class="badge bg-light text-dark border">Current: {{ current_method }}</span>
            </div>
            <div class="card-body">
                <div class="row align-items-center mb-3">
                    <div class="col-md-6">
                        <p class="small text-muted mb-0">Bandingkan hasil ranking metode saat ini dengan metode lain untuk melihat konsistensi keputusan.</p>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-white"><i class="fas fa-exchange-alt"></i></span>
                            <select class="form-select" id="method1" disabled></select>
                            <span class="input-group-text bg-light">vs</span>
                            <select class="form-select" id="method2"></select>
                        </div>
                    </div>
                </div>

                <div class="table-responsive rounded border">
                    <table class="table table-hover align-middle mb-0 text-center">
                        <thead class="table-light">
                            <tr>
                                <th class="text-start ps-4">Alternatif</th>
                                <th id="thMethod1">Rank {{ current_method }}</th>
                                <th id="thMethod2">Rank Pembanding</th>
                                <th>Status Konsistensi</th>
                            </tr>
                        </thead>
                        <tbody id="methodBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // --- GLOBAL DATA FROM FLASK ---
    const GLOBAL_DATA = {
        alternatives: {{ alternatives | safe }},
        criteria: {{ criteria_type | tojson }},
        rawData: {{ json_raw | safe }},
        normData: {{ json_norm | safe }},
        methods: {{ methods_data | tojson }},
        currentMethod: "{{ current_method }}",
        apiUrl: "{{ url_for('api_recalculate') }}"
    };

    // --- 1. SENSITIVITY LOGIC (SLIDER 100%) ---
    let liveChartInstance = null;
    const ctxLive = document.getElementById('liveChart').getContext('2d');

    function initLiveChart() {
        liveChartInstance = new Chart(ctxLive, {
            type: 'bar',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', 
                scales: { x: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- NEW LOGIC: REMAINING SPACE ALLOCATION (Agar tidak meleber) ---
    const sliders = document.querySelectorAll('.weight-slider');
    let isUpdating = false;

    sliders.forEach(slider => {
        slider.addEventListener('input', function() {
            if (isUpdating) return;
            isUpdating = true;

            // 1. Ambil nilai slider yang sedang digeser (Current)
            let currentVal = parseFloat(this.value);
            
            // Hard limit: Jangan biarkan input melebihi 100 atau kurang dari 0
            if (currentVal > 100) currentVal = 100;
            if (currentVal < 0) currentVal = 0;
            
            // Set nilai visual slider ini segera agar responsif
            this.value = currentVal; 
            document.getElementById('badge_' + this.name).innerText = currentVal.toFixed(1) + "%";

            // 2. Identifikasi slider lain (Others)
            const otherSliders = Array.from(sliders).filter(s => s !== this);
            
            // Hitung total nilai slider lain SEBELUM perubahan ini
            const totalOthersCurrent = otherSliders.reduce((sum, s) => sum + parseFloat(s.value), 0);
            
            // 3. Hitung "Ruang Tersisa" (Remaining Space)
            const remainingSpace = 100 - currentVal;

            // 4. Distribusikan Sisa Ruang ke Slider Lain
            otherSliders.forEach(s => {
                let newVal;
                if (totalOthersCurrent === 0) {
                    // KASUS KHUSUS: Jika slider lain sebelumnya 0 semua
                    // Maka bagikan sisa ruang secara merata (Equal Split)
                    newVal = remainingSpace / otherSliders.length;
                } else {
                    // KASUS NORMAL: Bagikan secara proporsional
                    // Rumus: (Nilai Dia / Total Teman) * Sisa Ruang
                    let ratio = parseFloat(s.value) / totalOthersCurrent;
                    newVal = remainingSpace * ratio;
                }

                // Update Nilai Slider Lain
                s.value = newVal;
                document.getElementById('badge_' + s.name).innerText = newVal.toFixed(1) + "%";
            });

            isUpdating = false;
            debouncedSend(); // Kirim ke API
        });
    });

    // Debounce: Mengurangi jumlah request ke server saat slider digeser cepat
    let debounceTimer;
    function debouncedSend() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(sendSensitivityData, 300);
    }

    function sendSensitivityData() {
        let payload = {};
        sliders.forEach(s => {
            payload[s.name] = parseFloat(s.value);
        });

        fetch(GLOBAL_DATA.apiUrl, {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                document.getElementById('liveTableContainer').innerHTML = data.html_table;
                liveChartInstance.data.labels = data.chart_data.labels;
                liveChartInstance.data.datasets = data.chart_data.datasets;
                liveChartInstance.update();
            }
        });
    }

    // --- 2. HEAD TO HEAD LOGIC (VS) ---
    let compareChartInstance = null;

    function initCompare() {
        const selA = document.getElementById('selectA');
        const selB = document.getElementById('selectB');
        
        GLOBAL_DATA.alternatives.forEach((alt, idx) => {
            selA.add(new Option(alt, alt, false, idx === 0));
            selB.add(new Option(alt, alt, false, idx === 1));
        });

        const ctxComp = document.getElementById('compareRadar').getContext('2d');
        compareChartInstance = new Chart(ctxComp, {
            type: 'radar',
            data: { labels: Object.keys(GLOBAL_DATA.criteria), datasets: [] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { r: { suggestedMin: 0, suggestedMax: 1, ticks: { display: false } } }
            }
        });

        selA.addEventListener('change', updateCompare);
        selB.addEventListener('change', updateCompare);
        updateCompare(); 
    }

    function updateCompare() {
        const altA = document.getElementById('selectA').value;
        const altB = document.getElementById('selectB').value;

        document.getElementById('thA').innerText = altA;
        document.getElementById('thB').innerText = altB;

        const tbody = document.getElementById('compareBody');
        tbody.innerHTML = '';
        
        const criteriaList = Object.keys(GLOBAL_DATA.criteria);

        criteriaList.forEach(crit => {
            const valA = GLOBAL_DATA.rawData[altA][crit];
            const valB = GLOBAL_DATA.rawData[altB][crit];
            const type = GLOBAL_DATA.criteria[crit]; 
            
            let diff = valA - valB;
            // Jika Cost: kecil lebih baik (warna hijau jika diff < 0)
            let isBetter = (type === 'benefit' && diff > 0) || (type === 'cost' && diff < 0);
            let isWorse = (type === 'benefit' && diff < 0) || (type === 'cost' && diff > 0);
            
            let colorClass = isBetter ? 'text-success fw-bold' : (isWorse ? 'text-danger fw-bold' : 'text-muted');
            let icon = diff > 0 ? '▲' : (diff < 0 ? '▼' : '=');

            let row = `
                <tr>
                    <td class="text-start ps-4">${crit} <span class="badge bg-light text-dark border ms-1" style="font-size:0.6em">${type.toUpperCase()}</span></td>
                    <td>${valA}</td>
                    <td>${valB}</td>
                    <td class="${colorClass}">${icon} ${Math.abs(diff).toFixed(2)}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        // Update Radar Chart
        const dataA = criteriaList.map(c => GLOBAL_DATA.normData[altA][c]);
        const dataB = criteriaList.map(c => GLOBAL_DATA.normData[altB][c]);

        compareChartInstance.data.datasets = [
            { label: altA, data: dataA, borderColor: '#0d6efd', backgroundColor: 'rgba(13, 110, 253, 0.2)', borderWidth: 2 },
            { label: altB, data: dataB, borderColor: '#dc3545', backgroundColor: 'rgba(220, 53, 69, 0.2)', borderWidth: 2 }
        ];
        compareChartInstance.update();
    }


    // --- 3. METHOD ROBUSTNESS LOGIC ---
    function initMethodCheck() {
        const m1 = document.getElementById('method1');
        const m2 = document.getElementById('method2');

        m1.add(new Option(GLOBAL_DATA.currentMethod, GLOBAL_DATA.currentMethod));
        m2.add(new Option("-- Pilih Pembanding --", ""));
        Object.keys(GLOBAL_DATA.methods).forEach(m => {
            if(m !== GLOBAL_DATA.currentMethod) {
                m2.add(new Option(m, m));
            }
        });

        m2.addEventListener('change', () => {
            const selectedM2 = m2.value;
            if(!selectedM2) return;
            
            const tbody = document.getElementById('methodBody');
            tbody.innerHTML = '';
            document.getElementById('thMethod2').innerText = `Rank ${selectedM2}`;

            GLOBAL_DATA.alternatives.forEach(alt => {
                const r1 = GLOBAL_DATA.methods[GLOBAL_DATA.currentMethod][alt];
                const r2 = GLOBAL_DATA.methods[selectedM2][alt];
                
                if(!r1 || !r2) return;

                const rank1 = r1.Rank;
                const rank2 = r2.Rank;
                const match = rank1 === rank2;

                tbody.innerHTML += `
                    <tr>
                        <td class="text-start ps-4 fw-bold">${alt}</td>
                        <td><span class="badge bg-primary rounded-pill">#${rank1}</span> <small class="text-muted">(${r1.Score.toFixed(4)})</small></td>
                        <td><span class="badge bg-secondary rounded-pill">#${rank2}</span> <small class="text-muted">(${r2.Score.toFixed(4)})</small></td>
                        <td>
                            ${match 
                                ? '<span class="text-success fw-bold"><i class="fas fa-check-circle"></i> Konsisten</span>' 
                                : '<span class="text-warning fw-bold"><i class="fas fa-exclamation-circle"></i> Berbeda</span>'}
                        </td>
                    </tr>
                `;
            });
        });
    }

    // --- MAIN INIT ---
    document.addEventListener("DOMContentLoaded", function() {
        initLiveChart();
        sendSensitivityData(); // Load first data
        initCompare();
        initMethodCheck();
    });

</script>

<style>
 /* Slider Custom Styling - IMPROVED VERSION */
.weight-slider {
    -webkit-appearance: none;
    width: 100%;
    height: 8px;
    border-radius: 5px;
    background: linear-gradient(to right, #0d6efd 0%, #e9ecef 0%); /* Will be updated by JS */
    outline: none;
    cursor: pointer;
}

/* Firefox specific track styling */
.weight-slider::-moz-range-track {
    width: 100%;
    height: 8px;
    background: #e9ecef;
    border-radius: 5px;
}

/* Chrome/Safari/Edge track styling */
.weight-slider::-webkit-slider-runnable-track {
    width: 100%;
    height: 8px;
    background: #e9ecef;
    border-radius: 5px;
}

/* Thumb styles remain the same */
.weight-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #0d6efd;
    border: 3px solid #fff; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    cursor: pointer;
    transition: all .15s ease-in-out;
}

.weight-slider::-webkit-slider-thumb:hover {
    background: #0b5ed7;
    transform: scale(1.1);
}

.weight-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #0d6efd;
    border: 3px solid #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    cursor: pointer;
}

.weight-slider::-moz-range-thumb:hover {
    background: #0b5ed7;
    transform: scale(1.1);
}
    /* Table Styling Consistency */
    .table thead th {
        background-color: #f8fafc;
        color: #64748b;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .table td {
        font-size: 0.9rem;
    }
</style>

{% endblock %}