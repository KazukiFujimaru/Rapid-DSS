{% extends "base.html" %}
{% block body %}
<div class="card shadow-sm p-4">
    <h3 class="mb-3">‚öôÔ∏è Konfigurasi & Parameter Metode</h3>
    <p class="text-muted">Tentukan jenis kriteria (Cost/Benefit) dan sesuaikan parameter algoritma jika diperlukan.</p>
    
    <form method="POST">
        
        <div class="table-responsive mb-4">
            <table class="table table-hover border">
                <thead class="table-light">
                    <tr>
                        <th width="5%">Pilih</th>
                        <th>Nama Kriteria (Kolom)</th>
                        <th width="30%">Tipe Atribut</th>
                    </tr>
                </thead>
                <tbody>
                    {% for col in columns %}
                    {% if not loop.first %} <tr>
                        <td class="text-center">
                            <input class="form-check-input" type="checkbox" name="criteria" value="{{ col }}" checked>
                        </td>
                        <td class="fw-bold">{{ col }}</td>
                        <td>
                            <select name="type_{{ col }}" class="form-select form-select-sm">
                                <option value="benefit">Benefit (Makin Besar = Bagus)</option>
                                <option value="cost">Cost (Makin Kecil = Bagus)</option>
                            </select>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <label class="form-label fw-bold">Metode Pembobotan (Weighting)</label>
                <select name="weighting_method" class="form-select">
                    <option value="direct">Input Manual (Direct Rating)</option>
                    <option value="ahp">AHP (Pairwise Comparison)</option>
                    <option value="likert">Likert Scale (Rating 1-5)</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold">Metode Perankingan (Ranking)</label>
                <select name="ranking_method" id="rankingMethod" class="form-select" onchange="updateAdvancedOptions()">
                    <option value="topsis">TOPSIS (Ideal Solution)</option>
                    <option value="promethee">PROMETHEE (Outranking)</option> <option value="saw">SAW (Simple Additive Weighting)</option>
                    <option value="wp">WP (Weighted Product)</option>
                    <option value="moora">MOORA (Ratio Analysis)</option>
                    <option value="smart">SMART (Utility Theory)</option>
                </select>
            </div>
        </div>

        <div class="accordion mb-4" id="advancedAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingAdv">
                    <button class="accordion-button collapsed bg-light text-dark fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdv">
                        üõ†Ô∏è Pengaturan Algoritma Lanjutan (Advanced)
                    </button>
                </h2>
                <div id="collapseAdv" class="accordion-collapse collapse" data-bs-parent="#advancedAccordion">
                    <div class="accordion-body bg-light">
                        
                        <div id="opt_topsis" class="method-option">
                            <h6 class="fw-bold text-primary">Parameter TOPSIS</h6>
                            <div class="row g-3 align-items-center">
                                <div class="col-md-4">
                                    <label class="small text-muted">Metric Jarak (Distance):</label>
                                    <select name="topsis_metric" class="form-select form-select-sm">
                                        <option value="euclidean" selected>Euclidean (Default)</option>
                                        <option value="manhattan">Manhattan (City Block)</option>
                                        <option value="chebyshev">Chebyshev (Max Deviation)</option>
                                    </select>
                                </div>
                                <div class="col-md-8">
                                    <small class="text-muted d-block mt-3">
                                        *Euclidean cocok untuk data umum. Manhattan lebih robust terhadap outlier.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div id="opt_promethee" class="method-option" style="display:none;">
                            <h6 class="fw-bold text-primary">Parameter PROMETHEE</h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="small text-muted">Tipe Fungsi Preferensi:</label>
                                    <select name="promethee_pref" class="form-select form-select-sm" onchange="toggleThreshold(this.value)">
                                        <option value="usual" selected>Tipe 1: Usual (Strict 0/1)</option>
                                        <option value="linear">Tipe 5: Linear (Gradual)</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="small text-muted">Output Ranking:</label>
                                    <select name="promethee_type" class="form-select form-select-sm">
                                        <option value="ii" selected>PROMETHEE II (Net Flow / Complete)</option>
                                        <option value="i">PROMETHEE I (Partial Ranking)</option>
                                    </select>
                                </div>
                                <div class="col-md-4" id="promethee_threshold_box" style="display:none;">
                                    <label class="small text-muted">Threshold Preferensi (p):</label>
                                    <input type="number" name="promethee_p" class="form-control form-control-sm" placeholder="Contoh: 1000" value="0">
                                    <small class="text-muted" style="font-size: 0.7em;">Selisih min. agar dominan mutlak.</small>
                                </div>
                            </div>
                        </div>

                        <div id="opt_ahp" class="method-option" style="display:none;">
                            <h6 class="fw-bold text-primary">Parameter AHP (Analytic Hierarchy Process)</h6>
                            <div class="row align-items-center">
                                <div class="col-md-5">
                                    <label class="small text-muted">Batas Toleransi Konsistensi (CR Threshold):</label>
                                    <select name="ahp_cr" class="form-select form-select-sm">
                                        <option value="0.1" selected>0.1 (Strict / Standar Saaty)</option>
                                        <option value="0.2">0.2 (Longgar / Moderat)</option>
                                        <option value="1.0">Abaikan Konsistensi (Paksa Hitung)</option>
                                    </select>
                                </div>
                                <div class="col-md-7">
                                    <small class="text-muted">
                                        Jika CR > Batas, sistem akan meminta input ulang. Pilih "Abaikan" untuk tetap memproses bobot yang tidak konsisten.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div id="opt_default" class="method-option" style="display:none;">
                            <p class="text-muted small mb-0">Tidak ada parameter khusus untuk metode ini. Menggunakan pengaturan standar.</p>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-primary btn-lg px-5">Lanjut ke Pembobotan &rarr;</button>
        </div>
    </form>
</div>

<script>
    function updateAdvancedOptions() {
        // Ambil Metode Ranking & Weighting
        const rankMethod = document.getElementById('rankingMethod').value;
        const weightMethod = document.querySelector('select[name="weighting_method"]').value; // FIX selector
        
        // Reset Display
        document.querySelectorAll('.method-option').forEach(el => el.style.display = 'none');

        // Logic Tampilan
        if (rankMethod === 'topsis') {
            document.getElementById('opt_topsis').style.display = 'block';
        } else if (rankMethod === 'promethee') {
            document.getElementById('opt_promethee').style.display = 'block';
        }

        // Tampilkan AHP Setting jika Weighting = AHP (Independen dari ranking)
        if (weightMethod === 'ahp') {
            document.getElementById('opt_ahp').style.display = 'block';
        }
    }
    
    // PENTING: Tambahkan event listener untuk dropdown weighting juga
    document.querySelector('select[name="weighting_method"]').addEventListener('change', updateAdvancedOptions);

    function toggleThreshold(prefType) {
        const box = document.getElementById('promethee_threshold_box');
        if (prefType === 'linear') {
            box.style.display = 'block';
        } else {
            box.style.display = 'none';
        }
    }

    // Jalankan sekali saat load
    document.addEventListener("DOMContentLoaded", updateAdvancedOptions);
</script>
{% endblock %}  